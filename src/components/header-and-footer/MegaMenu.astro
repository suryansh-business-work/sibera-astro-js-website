---
interface Props {
  hasProductHeader?: boolean;
}

const { hasProductHeader = false } = Astro.props;

import { getAppsByCategory } from "../../data/apps-data";
import { getThemeByCategory } from "../../data/app-themes";

const appsByCategory = getAppsByCategory();
const categories = Object.keys(appsByCategory);

// Calculate top position based on whether product header is present
const topPosition = hasProductHeader ? "top-[160px]" : "top-[100px]";
---

<!-- Mega Menu Dialog -->
<div
  role="navigation"
  aria-label="Product categories and applications"
  class={`fixed inset-x-0 ${topPosition} bg-white shadow-2xl border-t-2 border-blue-500 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-[100] mega-menu`}
  style="height: 600px;"
>
  <div class="w-full h-full flex">
    <!-- Sidebar Navigation -->
    <aside
      class="w-80 bg-gray-50 border-r border-gray-200 h-full overflow-y-auto py-6 flex-shrink-0"
      aria-label="Product categories"
    >
      <ul class="space-y-2 px-4" role="list">
        {
          categories.map((category, index) => (
            <li>
              <button
                class={`category-btn w-full text-left px-4 py-3 rounded-lg text-sm font-semibold transition-colors duration-200 flex items-center justify-between ${index === 0 ? "bg-blue-600 text-white" : "text-gray-700 hover:bg-gray-100"}`}
                data-category={category}
                data-index={index}
                aria-label={`View ${category} applications`}
                aria-current={index === 0 ? "true" : "false"}
                type="button"
              >
                <span class="flex items-center gap-3">
                  <span
                    class={`w-8 h-8 rounded-md flex items-center justify-center text-xs font-bold ${index === 0 ? "bg-blue-700 text-white" : "bg-gray-200 text-gray-600"}`}
                  >
                    {category.substring(0, 2).toUpperCase()}
                  </span>
                  <span>{category}</span>
                </span>
                <i
                  class={`fa-solid fa-chevron-right text-xs ${index === 0 ? "opacity-100" : "opacity-0"}`}
                  aria-hidden="true"
                />
              </button>
            </li>
          ))
        }
      </ul>
    </aside>

    <!-- Content Area -->
    <main class="flex-1 h-full overflow-y-auto bg-white px-12 py-8">
      {
        categories.map((category, index) => {
          const apps = appsByCategory[category];
          const theme = getThemeByCategory(category);
          return (
            <div
              id={`category-content-${index}`}
              class={`category-content ${index === 0 ? "block" : "hidden"}`}
              role="region"
              aria-label={`${category} applications`}
            >
              <div class="mb-6 pb-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3 mb-2">
                  {category}
                  <span class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700">
                    {apps.length} {apps.length === 1 ? "App" : "Apps"}
                  </span>
                </h2>
                <p class="text-gray-600">
                  Explore our suite of {category.toLowerCase()} applications
                  designed to transform your business.
                </p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {apps.map((app) => (
                  <a
                    href={`/app/${app.appSlug || app.appName.toLowerCase().replace(/\s+/g, "-")}`}
                    class="group block p-4 rounded-lg border border-gray-200 hover:border-blue-500 hover:shadow-lg transition-all duration-200 bg-white"
                    aria-label={`Learn more about ${app.appName}`}
                  >
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0">
                        <div
                          class="w-11 h-11 rounded-lg flex items-center justify-center p-2 shadow"
                          style={`background-color: ${theme.primaryColor};`}
                          aria-hidden="true"
                        >
                          <img
                            src={app.appLogo}
                            alt=""
                            class="w-full h-full object-contain"
                          />
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <h3 class="text-base font-bold text-gray-900 group-hover:text-blue-600 mb-1 transition-colors">
                          {app.appName}
                        </h3>
                        <p class="text-sm text-gray-600 line-clamp-2 leading-snug mb-2">
                          {app.appDescription}
                        </p>
                        <span
                          class={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${app.launchState === "mvp" ? "bg-green-100 text-green-700" : "bg-amber-100 text-amber-700"}`}
                        >
                          <span
                            class={`w-1.5 h-1.5 rounded-full ${app.launchState === "mvp" ? "bg-green-500" : "bg-amber-500"}`}
                            aria-hidden="true"
                          />
                          {app.launchState === "mvp"
                            ? "Available"
                            : "Coming Soon"}
                        </span>
                      </div>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          );
        })
      }
    </main>
  </div>
</div>

<style>
  /* Custom Scrollbar */
  .overflow-y-auto::-webkit-scrollbar {
    width: 6px;
  }
  .overflow-y-auto::-webkit-scrollbar-track {
    background: transparent;
  }
  .overflow-y-auto::-webkit-scrollbar-thumb {
    background-color: #e2e8f0;
    border-radius: 10px;
  }
  .overflow-y-auto:hover::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
  }

  /* Focus visible styles */
  .category-btn:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  a:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const buttons: any = document.querySelectorAll("[data-category]");
    const contents = document.querySelectorAll(".category-content");

    function switchCategory(index: number) {
      // Reset all buttons
      buttons.forEach((btn: any, i: any) => {
        const isActive = i === index;

        if (isActive) {
          btn.classList.remove("text-gray-700", "hover:bg-gray-100");
          btn.classList.add("bg-blue-600", "text-white");
        } else {
          btn.classList.remove("bg-blue-600", "text-white");
          btn.classList.add("text-gray-700", "hover:bg-gray-100");
        }

        btn.setAttribute("aria-current", isActive ? "true" : "false");

        const icon = btn.querySelector("i");
        const badge = btn.querySelector("span > span");

        if (icon) {
          icon.classList.toggle("opacity-100", isActive);
          icon.classList.toggle("opacity-0", !isActive);
        }

        if (badge) {
          if (isActive) {
            badge.classList.remove("bg-gray-200", "text-gray-600");
            badge.classList.add("bg-blue-700", "text-white");
          } else {
            badge.classList.remove("bg-blue-700", "text-white");
            badge.classList.add("bg-gray-200", "text-gray-600");
          }
        }
      });

      // Show appropriate content
      contents.forEach((content, i) => {
        if (i === index) {
          content.classList.remove("hidden");
          content.classList.add("block");
        } else {
          content.classList.add("hidden");
          content.classList.remove("block");
        }
      });
    }

    // Add event listeners
    buttons.forEach((button: any, idx: any) => {
      button.addEventListener("click", () => switchCategory(idx));
      button.addEventListener("mouseenter", () => switchCategory(idx));

      button.addEventListener("keydown", (e: KeyboardEvent) => {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          const nextIndex = (idx + 1) % buttons.length;
          (buttons[nextIndex] as HTMLElement).focus();
          switchCategory(nextIndex);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          const prevIndex = (idx - 1 + buttons.length) % buttons.length;
          (buttons[prevIndex] as HTMLElement).focus();
          switchCategory(prevIndex);
        }
      });
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const megaMenu = document.querySelector(".mega-menu");
        const productsButton = document.querySelector(
          '[aria-haspopup="dialog"]',
        ) as HTMLElement;

        if (megaMenu && !megaMenu.classList.contains("invisible")) {
          const parentGroup = megaMenu.closest(".group");
          if (parentGroup) {
            parentGroup.dispatchEvent(new MouseEvent("mouseleave"));
            productsButton?.focus();
          }
        }
      }
    });
  });
</script>
