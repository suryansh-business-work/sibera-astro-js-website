---
interface Props {
  hasProductHeader?: boolean;
}

const { hasProductHeader = false } = Astro.props;

import { getAppsByCategory } from "../../data/apps-data";
import { getThemeByCategory } from "../../data/app-themes";

const appsByCategory = getAppsByCategory();
const categories = Object.keys(appsByCategory);

// Calculate top position based on whether product header is present
const topPosition = hasProductHeader ? "top-[180px]" : "top-[120px]";
---

<!-- Mega Menu Dialog --><!-- Hover Bridge - invisible area to prevent menu from closing -->
<div
  class={`fixed inset-x-0 ${topPosition} h-3 -translate-y-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible pointer-events-auto z-[99]`}
  aria-hidden="true"
>
</div>

<div
  role="navigation"
  aria-label="Product categories and applications"
  class={`fixed inset-x-0 ${topPosition} bg-white shadow-2xl border-t-4 border-blue-600 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 ease-in-out z-[100] mega-menu`}
  style="height: 620px;"
>
  <div class="w-full h-full flex">
    <!-- Sidebar Navigation -->
    <aside
      class="w-72 bg-gray-50 border-r border-gray-200 h-full overflow-y-auto py-6 flex-shrink-0"
      aria-label="Product categories"
    >
      <ul class="space-y-2 px-4" role="list">
        {
          categories.map((category, index) => {
            const theme = getThemeByCategory(category);
            return (
              <li>
                <button
                  class={`category-btn w-full text-left px-4 py-3.5 rounded-lg border-l-4 text-base font-bold transition-all duration-300 flex items-center justify-between group/btn ${index === 0 ? "shadow-sm bg-white" : "border-transparent text-gray-600 hover:bg-white hover:text-gray-900 hover:shadow-sm"}`}
                  style={
                    index === 0
                      ? `color: ${theme.primaryColor}; border-left-color: ${theme.primaryColor};`
                      : ""
                  }
                  data-category={category}
                  data-index={index}
                  data-primary-color={theme.primaryColor}
                  data-bg-color={theme.backgroundColor}
                  aria-label={`View ${category} applications`}
                  aria-current={index === 0 ? "true" : "false"}
                  type="button"
                >
                  <span class="flex items-center gap-3">
                    <span>{category}</span>
                  </span>
                  <i
                    class={`fa-solid fa-chevron-right text-sm transition-all duration-300 ${index === 0 ? "opacity-100 translate-x-0" : "opacity-0 -translate-x-2 group-hover/btn:opacity-60 group-hover/btn:translate-x-0"}`}
                    aria-hidden="true"
                  />
                </button>
              </li>
            );
          })
        }
      </ul>
    </aside>

    <!-- Content Area -->
    <main
      class="flex-1 h-full overflow-y-auto bg-white px-10 py-8 flex flex-col"
    >
      <div class="flex-1">
        {
          categories.map((category, index) => {
            const apps = appsByCategory[category];
            const theme = getThemeByCategory(category);
            return (
              <div
                id={`category-content-${index}`}
                class={`category-content ${index === 0 ? "block" : "hidden"}`}
                role="region"
                aria-label={`${category} applications`}
              >
                <div class="mb-8 pb-6 border-b-2 border-gray-200">
                  <h2 class="text-3xl font-bold text-gray-900 flex items-center gap-4 mb-3">
                    {category}
                    <span class="px-3 py-1 rounded-full text-sm font-bold bg-gray-900 text-white">
                      {apps.length} {apps.length === 1 ? "App" : "Apps"}
                    </span>
                  </h2>
                  <p class="text-gray-600 text-base">
                    Explore our suite of {category.toLowerCase()} applications
                    designed to transform your business.
                  </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {apps.map((app) => (
                    <a
                      href={`/app/${app.appSlug || app.appName.toLowerCase().replace(/\s+/g, "-")}`}
                      class="group/card block p-5 rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:shadow-lg transition-all duration-300 bg-white transform hover:-translate-y-1"
                      aria-label={`Learn more about ${app.appName}`}
                    >
                      <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                          <img
                            src={app.appLogo}
                            alt=""
                            class="w-14 h-14 object-contain transform group-hover/card:scale-110 transition-transform duration-300"
                          />
                        </div>
                        <div class="flex-1 min-w-0">
                          <h3 class="text-base font-bold text-gray-900 group-hover/card:text-blue-600 mb-1.5 transition-colors duration-300">
                            {app.appName}
                          </h3>
                          <p class="text-sm text-gray-600 line-clamp-2 leading-relaxed mb-2.5">
                            {app.appDescription}
                          </p>
                          <span
                            class={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-semibold ${app.launchState === "mvp" ? "bg-green-100 text-green-700 border border-green-300" : "bg-amber-100 text-amber-700 border border-amber-300"}`}
                          >
                            <span
                              class={`w-1.5 h-1.5 rounded-full ${app.launchState === "mvp" ? "bg-green-600" : "bg-amber-600"} animate-pulse`}
                              aria-hidden="true"
                            />
                            {app.launchState === "mvp"
                              ? "Available"
                              : "Coming Soon"}
                          </span>
                        </div>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            );
          })
        }
      </div>

      <!-- View All Products Link -->
      <div class="mt-8 pt-6 border-t-2 border-gray-200">
        <a
          href="/all-products"
          class="group inline-flex items-center justify-center gap-3 px-8 py-4 bg-gray-900 hover:bg-gray-800 text-white text-base font-bold rounded-xl transition-all duration-300 w-full sm:w-auto shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
        >
          <i class="fa-solid fa-grid text-lg"></i>
          <span class="text-white">View All Products</span>
          <i
            class="fa-solid fa-arrow-right text-sm group-hover:translate-x-1 transition-transform duration-300"
          ></i>
        </a>
      </div>
    </main>
  </div>
</div>

<style>
  /* Custom Scrollbar */
  .overflow-y-auto::-webkit-scrollbar {
    width: 6px;
  }
  .overflow-y-auto::-webkit-scrollbar-track {
    background: transparent;
  }
  .overflow-y-auto::-webkit-scrollbar-thumb {
    background-color: #e5e7eb;
    border-radius: 10px;
  }
  .overflow-y-auto:hover::-webkit-scrollbar-thumb {
    background-color: #d1d5db;
  }

  /* Focus visible styles */
  .category-btn:focus-visible {
    outline: 3px solid #3b82f6;
    outline-offset: 2px;
  }

  a:focus-visible {
    outline: 3px solid #3b82f6;
    outline-offset: 2px;
  }

  /* Smooth hover delay to prevent accidental close */
  .group:hover .mega-menu,
  .group:hover .mega-menu + div {
    transition-delay: 0ms;
  }

  .mega-menu {
    transition:
      opacity 300ms cubic-bezier(0.4, 0, 0.2, 1),
      visibility 300ms cubic-bezier(0.4, 0, 0.2, 1),
      transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
    transition-delay: 100ms;
    transform: translateY(-10px);
  }

  .group:hover .mega-menu {
    transform: translateY(0);
  }

  .group:not(:hover) .mega-menu {
    transition-delay: 150ms;
    transform: translateY(-10px);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .animate-fadeIn {
    animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .category-content.block > div:first-child {
    animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .category-content.block .group\/card {
    animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .category-content.block .group\/card:nth-child(1) {
    animation-delay: 0.05s;
  }
  .category-content.block .group\/card:nth-child(2) {
    animation-delay: 0.1s;
  }
  .category-content.block .group\/card:nth-child(3) {
    animation-delay: 0.15s;
  }
  .category-content.block .group\/card:nth-child(4) {
    animation-delay: 0.05s;
  }
  .category-content.block .group\/card:nth-child(5) {
    animation-delay: 0.1s;
  }
  .category-content.block .group\/card:nth-child(6) {
    animation-delay: 0.15s;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const buttons: any = document.querySelectorAll("[data-category]");
    const contents = document.querySelectorAll(".category-content");
    const megaMenu = document.querySelector(".mega-menu") as HTMLElement;

    // Initialize first category color if needed
    if (buttons.length > 0 && megaMenu) {
      const firstBtn = buttons[0];
      const primaryColor = firstBtn.getAttribute("data-primary-color");
      if (primaryColor) {
        megaMenu.style.borderTopColor = primaryColor;
      }
    }

    function switchCategory(index: number) {
      // Reset all buttons
      buttons.forEach((btn: any, i: any) => {
        const isActive = i === index;
        const primaryColor = btn.getAttribute("data-primary-color");

        if (isActive) {
          btn.classList.remove(
            "border-transparent",
            "text-gray-600",
            "hover:bg-white",
            "hover:text-gray-900",
            "hover:shadow-sm",
          );
          btn.classList.add("shadow-sm", "bg-white");
          btn.style.color = primaryColor;
          btn.style.borderLeftColor = primaryColor;

          // Update mega menu top border
          if (megaMenu) {
            megaMenu.style.borderTopColor = primaryColor;
          }
        } else {
          // Reset styles
          btn.style.color = "";
          btn.style.borderLeftColor = "";
          btn.classList.remove("shadow-sm", "bg-white");

          btn.classList.add(
            "border-transparent",
            "text-gray-600",
            "hover:bg-white",
            "hover:text-gray-900",
            "hover:shadow-sm",
          );
        }

        btn.setAttribute("aria-current", isActive ? "true" : "false");

        const icon = btn.querySelector("i");
        if (icon) {
          if (isActive) {
            icon.classList.add("opacity-100", "translate-x-0");
            icon.classList.remove("opacity-0", "-translate-x-2");
          } else {
            icon.classList.remove("opacity-100", "translate-x-0");
            icon.classList.add("opacity-0", "-translate-x-2");
          }
        }
      });

      // Show appropriate content with animation
      contents.forEach((content, i) => {
        if (i === index) {
          content.classList.remove("hidden");
          content.classList.add("block", "animate-fadeIn");
        } else {
          content.classList.add("hidden");
          content.classList.remove("block", "animate-fadeIn");
        }
      });
    }

    // Add event listeners
    buttons.forEach((button: any, idx: any) => {
      button.addEventListener("click", () => switchCategory(idx));
      button.addEventListener("mouseenter", () => switchCategory(idx));

      button.addEventListener("keydown", (e: KeyboardEvent) => {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          const nextIndex = (idx + 1) % buttons.length;
          (buttons[nextIndex] as HTMLElement).focus();
          switchCategory(nextIndex);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          const prevIndex = (idx - 1 + buttons.length) % buttons.length;
          (buttons[prevIndex] as HTMLElement).focus();
          switchCategory(prevIndex);
        }
      });
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const megaMenu = document.querySelector(".mega-menu");
        const productsButton = document.querySelector(
          '[aria-haspopup="dialog"]',
        ) as HTMLElement;

        if (megaMenu && !megaMenu.classList.contains("invisible")) {
          const parentGroup = megaMenu.closest(".group");
          if (parentGroup) {
            parentGroup.dispatchEvent(new MouseEvent("mouseleave"));
            productsButton?.focus();
          }
        }
      }
    });
  });
</script>
